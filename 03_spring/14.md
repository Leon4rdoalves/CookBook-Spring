<h1>Introdu√ß√£o a Spring Security</h1>

<div align="center"><img src="https://i.imgur.com/1WNTDKW.png" title="source: imgur.com" /></div>

No mundo da tecnologia, em especial da Internet, nenhuma aplica√ß√£o em execu√ß√£o na Nuvem pode ficar sem algum tipo de Seguran√ßa habilitada, devido aos in√∫meros perigos existentes no mundo virtual como ataques Hackers, invas√µes de Servidores, roubos de dados, entre outros. No ecossistema Spring, isso √© feito com a ajuda da **Depend√™ncia Spring Security**.

Vamos adicionar a **Depend√™ncia Spring Security** no Projeto Blog Pessoal, adicionando as linhas abaixo no arquivo **pom.xml**, Salvar e Executar a aplica√ß√£o:

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-security</artifactId>
</dependency>
```

Abra a sua aplica√ß√£o no Navegador da Internet atrav√©s do endere√ßo: **http://localhost:8080** e veja o que acontece.

<div align="center"><img src="https://i.imgur.com/k19Ci4j.png?2" title="source: imgur.com" /></div>

Como num passe de m√°gica...

- ‚Ä¶ Voc√™ tem uma p√°gina de login gerada automaticamente.
- ‚Ä¶ Voc√™ n√£o pode mais executar solicita√ß√µes GET, POST, PUT e DELETE.
- ‚Ä¶ Todo o seu aplicativo est√° bloqueado e solicita que voc√™ insira um nome de usu√°rio e uma senha, que n√£o existe.

Tendo sobrevivido ao susto inicial, voc√™ deve ter pensado: Como tudo isso aconteceu?

<h2>1. Seguran√ßa da Aplica√ß√£o</h2>

Antes de estudarmos a Spring Security, vamos compreender 3 conceitos importantes da Seguran√ßa da Informa√ß√£o:

<h3>1.1. Autentica√ß√£o</h3>

<div align="center"><img src="https://i.imgur.com/j6XK5if.png" title="source: imgur.com" /></div>

√â o primeiro processo da Seguran√ßa da Informa√ß√£o, popularmente conhecido como Login no sistema. √â o momento em que o usu√°rio informa o seu usu√°rio de acesso (e-mail) e a sua senha (criptografada), e o sistema far√° a checagem se estas informa√ß√µes est√£o corretas.

<h3>1.2. Autoriza√ß√£o</h3>

<div align="center"><img src="https://i.imgur.com/45GVPVJ.png?1" title="source: imgur.com" /></div>

√â o segundo processo da Seguran√ßa da Informa√ß√£o, popularmente conhecido como Direitos de acesso (Roles) no sistema. √â o momento em que o sistema checar√° o que o usu√°rio pode e n√£o pode fazer no sistema, ou seja, as suas permiss√µes dentro do sistema (Quais Recursos e Endpoints podem ser acessados?).

<h3>1.3. Filtros de Servlet</h3>

<div align="center"><img src="https://i.imgur.com/69yJ98D.png" title="source: imgur.com" /></div>

Qualquer aplicativo da web Spring √© apenas um **Servlet** (√© uma Classe Java usada para criar aplica√ß√µes WEB), que redireciona todas as Requisi√ß√µes HTTP recebidas (por exemplo, do Front-end Angular ou React), para as suas respectivas Classes Controladoras (**@RestControllers**). 

Como nestas requisi√ß√µes n√£o existe uma seguran√ßa e a autentica√ß√£o e a autoriza√ß√£o devem ser efetuadas antes das Requisi√ß√µes HTTP chegarem na Controladora, a Spring Security oferece como solu√ß√£o para este problema que s√£o os **Filtros**, que na pr√°tica s√£o Objetos que interceptam toda e qualquer Requisi√ß√£o HTTP recebida antes de chegarem ao controlador. Por isso que o seu Blog Pessoal est√° "trancado" ap√≥s a inser√ß√£o da Depend√™ncia Spring Security.

A figura acima, ilustra o filtro **BasicAuthenticationFilter** checando o Token de Autoriza√ß√£o do Usu√°rio enviado no cabe√ßalho da requisi√ß√£o. Como ele est√° dentro do padr√£o Basic, o filtro libera o envio da requisi√ß√£o para a Classe Controladora espec√≠fica.

A Depend√™ncia Spring Security ao ser inserida, habilita 15 filtros por padr√£o, onde cada um tem uma fun√ß√£o espec√≠fica. Ao customizar as configura√ß√µes da seguran√ßa, o Spring Security define quais filtros ser√£o habilitados, quais ser√£o desabilitados e permite ainda habilitar filtros personalizados criados pela pessoa desenvolvedora. N√£o abordaremos este assunto em detalhes por ser muito extenso, al√©m de demandar tempo e dedica√ß√£o, de qualquer forma voc√™ j√° sabe como a sua aplica√ß√£o ficou totalmente bloqueada. A Imagem abaixo mostra os 15 filtros padr√£o:

<div align="center"><img src="https://i.imgur.com/BLDM6DW.png" title="source: imgur.com" /></div>

<h2>2. Spring Security</h2>

Analisando nossos projetos podemos perceber que nossa API, at√© este momento, n√£o possu√≠a nenhuma seguran√ßa, ou seja, qualquer pessoa poderia acessar todos os nossos endpoints e ter acesso √† todos os recursos livremente. Precisamos entender que algumas aplica√ß√µes cont√©m informa√ß√µes vitais como: dados pessoais, dados banc√°rios, usu√°rio e senha de acesso, e portanto precisamos garantir que a nossa API e estes dados estejam devidamente protegidos. E para isto podemos contar com a depend√™ncia do Spring chamada **Spring Security** (adicionada acima).

A **Spring Security** √© um framework para Java, que prov√™ autentica√ß√£o, autoriza√ß√£o, filtros e diversas outras funcionalidades para aplica√ß√µes corporativas, com o objetivo de proteger a nossa aplica√ß√£o contra acessos indevidos. Iniciado em 2003 por Ben Alex, a Spring Security √© distribu√≠da sob a licen√ßa Apache Licence. Ela oferece diversos recursos que permitem que muitas pr√°ticas comuns de seguran√ßa sejam implementadas ou configuradas de forma direta. Veja como a Spring Security funciona na figura abaixo:

<div align="center"><img src="https://i.imgur.com/KWYDoep.png" title="source: imgur.com" /></div>

1) O Usu√°rio informa as suas credenciais (usu√°rio e senha);
2) A requisi√ß√£o HTTP gerada passar√° pelos **Servlets Filters**;
3) Passando pelos filtros habilitados, a requisi√ß√£o ser√° enviada para o **Authentication Manager**, que buscar√° um autenticador para a aplica√ß√£o.
4) O **Authetication Provider** √© o autenticador da aplica√ß√£o, ou seja, ele far√° a pesquisa no Banco de dados para validar o usu√°rio e a senha, atrav√©s da Interface **UserDetailsService**.
5) Ap√≥s a valida√ß√£o, o **Authentication Manager** gera uma resposta para a requisi√ß√£o confirmando a autentica√ß√£o (**OK ü°™ 200**) ou negando o acesso ao usu√°rio (**UNAUTHORIZED ü°™ 401**).

O esquema de autentica√ß√£o que utilizaremos em nosso projeto √© o **HTTP Basic**, onde o usu√°rio digitar√° o **e-mail (usu√°rio) e a senha** e atrav√©s de um endpoint liberado e o Spring Security ir√° criptografar a senha e consultar o nosso Banco de dados para validar se o usu√°rio existe. Esta checagem ser√° feita atrav√©s da Camada de Servi√ßo (service) da aplica√ß√£o. Se a consulta encontrar o usu√°rio e a senha, o Spring Security devolver√° como resposta um Token de  Authoriza√ß√£o Codificado. Este token ficar√° registrado na nossa aplica√ß√£o na camada de Security e apenas por meio dele que o usu√°rio poder√° consumir todos os endpoints da API.

Para melhor compreens√£o deste sistema, √© necess√°rio dividi-lo em 2 ecossistemas: **Usu√°rio** e **Seguran√ßa**, que veremos mais a frente.

<h2>3. Conhecendo HTTP Authentication</h2>

O **IETF (*Internet Engineering Task Force*)** tem como miss√£o identificar e propor solu√ß√µes para as quest√µes/problemas relacionados √† utiliza√ß√£o da Internet, al√©m de propor a padroniza√ß√£o das tecnologias e protocolos envolvidos. O mesmo define a estrutura de autentica√ß√£o HTTP que pode ser usada por um servidor para definir uma solicita√ß√£o do cliente. O servidor responde ao cliente com uma mensagem do tipo **HTTP Status 401 (N√£o autorizado)** e fornece informa√ß√µes de como autorizar com um cabe√ßalho de resposta **WWW-Authenticate** contendo ao menos uma solicita√ß√£o. Um cliente que deseja autenticar-se com um servidor pode fazer isso incluindo um campo de cabe√ßalho de solicita√ß√£o **WWW-Authenticate** com as credenciais. No Diagrama de Sequ√™ncia abaixo pode se observar este relacionamento:

<div align="center"><img src="https://i.imgur.com/PAQBkKK.jpg" title="source: imgur.com" /></div>

No caso de uma **autoriza√ß√£o ‚ÄúBasic‚Äù** (como a mostra a figura acima), a troca deve acontecer por meio de uma conex√£o HTTP (TLS) para ser segura. Se um servidor recebe credenciais v√°lidas, mas que n√£o s√£o adequadas para ter acesso a um determinado recurso, o servidor responder√° com o c√≥digo de status **HTTP Status 403 (Proibido!)** . Ao contr√°rio de **HTTP Status 401(N√£o autorizado)**, a autentica√ß√£o √© imposs√≠vel para este usu√°rio. O cabe√ßalho de requisi√ß√£o **Authorization** cont√©m as credenciais para autenticar um agente de usu√°rio com um servidor. Aqui o tipo √© novamente necess√°rio, seguido pelas credenciais, que podem ser codificadas ou criptografadas dependendo do esquema de autentica√ß√£o usado. No caso acima foi utilizado o esquema de autentica√ß√£o Basic que ser√° explicado na sequencia.

<div align="left"><img src="https://i.imgur.com/cDPH4tl.png" title="source: imgur.com" width="30px"/> <a href="https://developer.mozilla.org/pt-BR/docs/Web/HTTP/Status/401" target="_blank"><b>Documenta√ß√£o: HTTP Status Code 401 - Unauthorized</b></a></div>

<div align="left"><img src="https://i.imgur.com/cDPH4tl.png" title="source: imgur.com" width="30px"/> <a href="https://developer.mozilla.org/pt-BR/docs/Web/HTTP/Status/403" target="_blank"><b>Documenta√ß√£o: HTTP Status Code 403 - Forbidden</b></a></div>

<div align="left"><img src="https://i.imgur.com/cDPH4tl.png" title="source: imgur.com" width="30px"/> <a href="https://developer.mozilla.org/pt-BR/docs/Web/HTTP/Headers/WWW-Authenticate" target="_blank"><b>Documenta√ß√£o: Cabe√ßalho HTTP WWW-Authenticate</b></a></div>

<div align="left"><img src="https://i.imgur.com/cDPH4tl.png" title="source: imgur.com" width="30px"/> <a href="https://developer.mozilla.org/pt-BR/docs/Web/HTTP/Headers/Authorization" target="_blank"><b>Documenta√ß√£o: Cabe√ßalho de Requisi√ß√£o HTTP Authorization</b></a></div>

<h3>3.1. Esquema de autentica√ß√£o Basic</h3>

A estrutura geral de autentica√ß√£o HTTP √© usado por v√°rios esquemas de autentica√ß√£o. Os esquemas podem divergir na for√ßa da seguran√ßa e na disponibilidade do software cliente ou servidor. O esquema mais comum de autentica√ß√£o √© o ‚ÄúBasic‚Äù, mas existem outros esquemas oferecidos por servi√ßos de hospedagem, como AWS, Google ou Microsoft. Os esquemas de autentica√ß√£o mais comuns s√£o:

| Esquema de autentica√ß√£o | Documenta√ß√£o                                                |
| ----------------------- | ----------------------------------------------------------- |
| Basic                   | [[RFC7617](https://www.iana.org/go/rfc7617)]                |
| Bearer                  | [[RFC6750](https://www.iana.org/go/rfc6750)]                |
| Digest                  | [[RFC7616](https://www.iana.org/go/rfc7616)]                |
| HOBA                    | [[RFC7486, Section 3](https://www.iana.org/go/rfc7486)]     |
| Mutual                  | [[RFC8120](https://www.iana.org/go/rfc8120)]                |
| Negotiate               | [[RFC4559, Section 3](https://www.iana.org/go/rfc4559)]     |
| OAuth                   | [[RFC5849, Section 3.5.1](https://www.iana.org/go/rfc5849)] |
| SCRAM-SHA-1             | [[RFC7804](https://www.iana.org/go/rfc7804)]                |
| SCRAM-SHA-256           | [[RFC7804](https://www.iana.org/go/rfc7804)]                |
| vapid                   | [[RFC 8292, Section 3](https://www.iana.org/go/rfc8292)]    |

|<img src="https://i.imgur.com/hOgWvSc.png" title="source: imgur.com" width="350px"/>  | <div align="left">**ATEN√á√ÉO:** Para melhor compreens√£o no momento, vamos focar apenas no entendimento do formato Basic, que √© considerado o principal esquema para compreender os demais meios de autoriza√ß√£o. Vale mencionar que para aprender os demais √© necess√°rio tempo e muita dedica√ß√£o.</div> |
| ----------------------------------------------------- | ------------------------------------------------------------ |

O esquema **Basic**, segundo sua documenta√ß√£o, consiste em um conjunto de caracteres que posicionados ap√≥s a palavra **"Basic "** no formato **‚Äúemail:senha‚Äù** codificados utilizando o modelo **Base64**, formando um token ***Authorization*** para ser passado ao sistema. Abaixo veremos um exemplo de c√≥digo para gerar a estrutura em Java:

#### **Depend√™ncia:**

```xml
<!-- Depend√™ncia para Codifica√ß√£o do Token -->
<dependency>
    <groupId>commons-codec</groupId>
    <artifactId>commons-codec</artifactId>
</dependency>
```

#### **Exemplo de c√≥digo em java:**

```java
import java.nio.charset.Charset;
import org.apache.commons.codec.binary.Base64;

private static String geradorBasicToken(String email, String senha) {
    String estrutura = email + ":" + senha;
    byte[] estruturaBase64 = 
        Base64.encodeBase64(estrutura.getBytes(Charset.forName("US-ASCII")));
    return "Basic " + new String(estruturaBase64);
}
```

 O resultado do c√≥digo acima proporciona o retorno de um esquema de autentica√ß√£o Basic respeitando as regras ja definidas pela IETF (*Internet Engineering Task Force*).

**Exemplo:**

**Usu√°rio:** *admin@email.com.br*

**Senha:** *admin123*

**Estrutura do Token:** Basic admin@email.com.br:admin123

**Token gerado com o e-mail e a senha codificados em Base 64:** *Basic YWRtaW5AZW1haWwuY29tLmJyOmFkbWluMTIz* 

| <img src="https://i.imgur.com/vVDBDG0.png" title="source: imgur.com" width="200px"/> | ALERTA DE BSM: Mantenha a Aten√ß√£o aos Detalhes ao escrever o formato Basic, o mesmo √© representado da palavra "*Basic* " com um espa√ßo na frente + a criptografia de um conjunto de caracteres (*email:senha*) fornecidos ao se autenticar no sistema. |
| ------------------------------------------------------------ | :----------------------------------------------------------- |

| <img src="https://i.imgur.com/RfjtOFi.png" title="source: imgur.com" width="120px"/> | <div align="left">Dica: No primeiro link abaixo voc√™ pode conhecer mais sobre a codifica√ß√£o em Base 64 e no segundo link voc√™ pode testar a codifica√ß√£o e a decodifica√ß√£o de Strings geradas atrav√©s da Codifica√ß√£o em 64 bits.</div> |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

<div align="left"><img src="https://i.imgur.com/RlHVydi.png" title="source: imgur.com" width="25px"/> <a href="https://pt.wikipedia.org/wiki/Base64" target="_blank"><b>Artigo: Modelo Base 64</b></a> - Como funciona o modelo de Codifica√ß√£o Base 64.</div>

<div align="left"><img src="https://i.imgur.com/RlHVydi.png" title="source: imgur.com" width="25px"/> <a href="https://www.base64url.com" target="_blank"><b>Ferramenta: Codificador Base 64</b></a> - Ferramenta para codificar e decodificar Strings no modelo Base 64.</div>

<br />

O Token gerado ser√° enviado no Header (cabe√ßalho) de uma requisi√ß√£o ao servidor devidamente configurado para acessar os seus recursos. Sem este token, todos os endpoints protegidos por autentica√ß√£o retornar√£o como resposta o status acesso negado (**UNAUTHORIZED ü°™ 401**).

<br /><br />
	

<div align="left"><a href="README.md"><img src="https://i.imgur.com/XMgF3gl.png" title="source: imgur.com" width="3%"/>Voltar</a></div>

